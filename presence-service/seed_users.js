// {
//     "users": [
//         {
//             "username": "korede_onakoya",
//             "first_name": "Korede",
//             "last_name": "Onakoya",
//             "avatar": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQBvqzyx_zoi6q2c0Gd1XnE7wysD9PGOLe3-A&s",
//             "lastSeen": "2025-10-12T10:05:00Z",
//             "isOnline": true
//         },
//         {
//             "username": "amara_okafor",
//             "first_name": "Amara",
//             "last_name": "Okafor",
//             "avatar": "https://www.shutterstock.com/image-photo/handsome-happy-african-american-bearded-600nw-2460702995.jpg",
//             "lastSeen": "2025-10-12T09:50:00Z",
//             "isOnline": false
//         },
//         {
//             "username": "tunde_balogun",
//             "first_name": "Tunde",
//             "last_name": "Balogun",
//             "avatar": "https://images.pexels.com/photos/1181391/pexels-photo-1181391.jpeg?auto=compress&cs=tinysrgb&dpr=1&w=500",
//             "lastSeen": "2025-10-12T09:45:00Z",
//             "isOnline": false
//         },
//         {
//             "username": "zainab_ali",
//             "first_name": "Zainab",
//             "last_name": "Ali",
//             "avatar": "https://media.gettyimages.com/id/1987655119/photo/smiling-young-businesswoman-standing-in-the-corridor-of-an-office.jpg?s=612x612&w=gi&k=20&c=jyEtRXr75_9MGh9BvKh1wmTulOnFyWqTtcV8Gin9LEg=",
//             "lastSeen": "2025-10-12T10:00:00Z",
//             "isOnline": true
//         },
//         {
//             "username": "emeka_nwosu",
//             "first_name": "Emeka",
//             "last_name": "Nwosu",
//             "avatar": "https://images.pexels.com/photos/2379005/pexels-photo-2379005.jpeg?auto=compress&cs=tinysrgb&dpr=1&w=500",
//             "lastSeen": "2025-10-12T09:30:00Z",
//             "isOnline": false
//         },
//         {
//             "username": "fatima_abdullahi",
//             "first_name": "Fatima",
//             "last_name": "Abdullahi",
//             "avatar": "https://media.gettyimages.com/id/1500511127/photo/portrait-of-an-indian-young-adult-woman-looking-at-camera.jpg?s=612x612&w=gi&k=20&c=081IjHl0mERpRg-Fi3lVUQUjxFMqJWDfRJwDBJ3s6KM=",
//             "lastSeen": "2025-10-12T09:59:00Z",
//             "isOnline": true
//         },
//         {
//             "username": "daniel_adewale",
//             "first_name": "Daniel",
//             "last_name": "Adewale",
//             "avatar": "https://plus.unsplash.com/premium_photo-1682144187125-b55e638cf286?ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MXx8bWVuJTIwcG9ydHJhaXR8ZW58MHx8MHx8fDA%3D&fm=jpg&q=60&w=3000",
//             "lastSeen": "2025-10-12T09:20:00Z",
//             "isOnline": false
//         },
//         {
//             "username": "chioma_eze",
//             "first_name": "Chioma",
//             "last_name": "Eze",
//             "avatar": "https://img.freepik.com/free-photo/beautiful-girl-stands-park_8353-5084.jpg?semt=ais_hybrid&w=740&q=80",
//             "lastSeen": "2025-10-12T09:15:00Z",
//             "isOnline": false
//         },
//         {
//             "username": "bola_johnson",
//             "first_name": "Bola",
//             "last_name": "Johnson",
//             "avatar": "https://media.istockphoto.com/id/544358212/photo/happy-laughing-man.jpg?s=612x612&w=0&k=20&c=FwJw5gqpUX3A8jOdsnIqQmSOxptVcYqHzaBkz6bvtMA=",
//             "lastSeen": "2025-10-12T10:10:00Z",
//             "isOnline": true
//         },
//         {
//             "username": "musa_ibrahim",
//             "first_name": "Musa",
//             "last_name": "Ibrahim",
//             "avatar": "https://m.media-amazon.com/images/I/414EMKaeksL._UF1000,1000_QL80_.jpg",
//             "lastSeen": "2025-10-12T08:45:00Z",
//             "isOnline": false
//         },
//         {
//             "username": "aisha_suleiman",
//             "first_name": "Aisha",
//             "last_name": "Suleiman",
//             "avatar": "https://media.istockphoto.com/id/629077354/photo/self-acceptance-goes-a-long-way-to-being-happy.jpg?s=612x612&w=0&k=20&c=XpmWw2GodU8bX89n9BBaef0aFHNg_TZecklxCa-KtwU=",
//             "lastSeen": "2025-10-12T09:05:00Z",
//             "isOnline": false
//         },
//         {
//             "username": "ifeanyi_okeke",
//             "first_name": "Ifeanyi",
//             "last_name": "Okeke",
//             "avatar": "https://st2.depositphotos.com/1021027/5542/i/450/depositphotos_55424329-stock-photo-beautiful-and-muscular-black-man.jpg",
//             "lastSeen": "2025-10-12T10:12:00Z",
//             "isOnline": true
//         },
//         {
//             "username": "ruth_agbaje",
//             "first_name": "Ruth",
//             "last_name": "Agbaje",
//             "avatar": "https://media.istockphoto.com/id/1369508766/photo/beautiful-successful-latin-woman-smiling.jpg?s=612x612&w=0&k=20&c=LoznG6eGT42_rs9G1dOLumOTlAveLpuOi_U755l_fqI=",
//             "lastSeen": "2025-10-12T09:00:00Z",
//             "isOnline": false
//         },
//         {
//             "username": "segun_akinola",
//             "first_name": "Segun",
//             "last_name": "Akinola",
//             "avatar": "https://plus.unsplash.com/premium_photo-1688740375397-34605b6abe48?ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MXx8ZmVtYWxlJTIwcHJvZmlsZXxlbnwwfHwwfHx8MA%3D%3D&fm=jpg&q=60&w=3000",
//             "lastSeen": "2025-10-12T10:03:00Z",
//             "isOnline": true
//         },
//         {
//             "username": "ngozi_chukwu",
//             "first_name": "Ngozi",
//             "last_name": "Chukwu",
//             "avatar": "https://thumbs.dreamstime.com/b/beauty-black-skin-woman-african-ethnic-female-face-young-african-american-model-long-afro-hair-smiling-model-isolated-163819588.jpg",
//             "lastSeen": "2025-10-12T08:50:00Z",
//             "isOnline": false
//         }
//     ]
// }

// rs.initiate({
//    _id: "rs0",
//    members: [
//       { _id: 0, host: "mongo1:27017" },
//       { _id: 1, host: "mongo2:27017" },
//       { _id: 2, host: "mongo3:27017" }
//    ]
// })


/**
 * MongoDB User Seeder Script
 * --------------------------
 * Generates 100 dummy user documents and inserts them into the MongoDB
 * 'presence_users' collection.
 *
 * Requirements:
 * 1. Node.js environment
 * 2. The official 'mongodb' package installed (npm install mongodb)
 *
 * Before running:
 * Set the MONGO_URI environment variable. Use the full replica set connection string
 * for testing the new multi-node setup.
 *
 * Example (Unix/Linux):
 * export MONGO_URI="mongodb://mongo1:27017,mongo2:27017,mongo3:27017/chatdb?replicaSet=rs0"
 * node seed_users.js
 */

const { MongoClient } = require('mongodb');
const mongoose = require('mongoose');

// const MONGO_URI = 'mongodb://mongo1:27017/presence_service?maxPoolSize=100';
const MONGO_URI = 'mongodb://mongo2:27017/presence_service?replicaSet=rs0&serverSelectionTimeoutMS=10000';

// --- CONFIGURATION ---
// IMPORTANT: Use the full Replica Set URI here.
// const MONGO_URI = process.env.MONGO_URI || "mongodb://localhost:27017/chatdb";
const DB_NAME = "presence_service";
const COLLECTION_NAME = "users";
const NUM_USERS = 10000;

// Connection options including the increased pool size (crucial for concurrency testing)
const clientOptions = {
    maxPoolSize: 200, // Timeout for the initial server selection process (e.g., finding the primary)
    // bufferTimeoutMS: 45000, // Timeout for operations (like deleteMany) buffered while waiting for connection/primary
    serverSelectionTimeoutMS: 30000,
};

// MongoDB user status schema provided by the user
const userSchema = new mongoose.Schema({
  username: String,
  first_name: String,
  avatar: String,
  last_name: String,
  lastSeen: Date,
  isOnline: Boolean,
});

// The model will use the collection name 'users'
const User = mongoose.model("User", userSchema);
// --- END CONFIGURATION ---


/**
 * Generates a mock Date object that is within the last 3 days
 * to simulate recent activity.
 * @param {number} index - The user index for variation.
 * @returns {string} ISO date string for lastSeen.
 */
function generateLastSeen(index) {
    const now = new Date();
    // Start with a timestamp roughly 3 days ago (259200000 ms in 3 days)
    const threeDaysAgo = now.getTime() - (3 * 24 * 60 * 60 * 1000); 
    // Add an offset based on index (up to 3 days) and reduce by 5 minutes per user
    const offset = (index * 5 * 60 * 1000); 
    
    // Create a time that is recent but variable
    const lastSeenTime = now.getTime() - offset;
    
    // Ensure it's not too far in the past (cap it near the 3-day mark)
    const finalTime = Math.max(lastSeenTime, threeDaysAgo); 
    
    return new Date(finalTime).toISOString();
}


/**
 * Generates an array of user objects.
 * @returns {Array<Object>} An array of 100 user documents.
 */
function generateUserData() {
    const users = [];
    const baseAvatar = "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQBvqzyx_zoi6q2c0Gd1XnE7wysD9PGOLe3-A&s";

    console.log(`Generating ${NUM_USERS} user documents...`);

    for (let i = 1; i <= NUM_USERS; i++) {
        const isOnline = i % 2 === 0; // Alternating online status
        
        users.push({
            username: `user${i}`,
            first_name: "User",
            last_name: `Test${i}`,
            avatar: baseAvatar,
            lastSeen: isOnline ? null : generateLastSeen(i), // Null if online
            isOnline: isOnline,
        });
    }

    return users;
}

/**
 * Connects to MongoDB and performs the bulk insertion.
 */
async function runSeeder() {
    const users = generateUserData();
    const client = new MongoClient(MONGO_URI, clientOptions);

    try {
        console.log(`Attempting to connect to MongoDB: ${MONGO_URI}`);
        // await client.connect();
        await mongoose.connect(MONGO_URI, clientOptions);
        console.log("Successfully connected to MongoDB.");
        
        // Clear existing data (optional, but good for clean seeding)
        const collectionName = User.collection.name;

        console.log(`Dropping existing documents in '${collectionName}'...`);
        // CRUCIAL FIX: Increase the max time this operation can wait for a primary node
        await User.deleteMany({}).maxTimeMS(45000); 
        
        // Insert the new documents
        console.log(`Inserting ${users.length} new documents...`);
        const result = await User.insertMany(users, { ordered: false });
        // const result = await collection.insertMany(users);
        
        console.log(`\n✅ Seeding complete! Inserted ${result.insertedCount} documents.`);

    } catch (err) {
        // If it's a timeout error, provide helpful context
        if (err.name === 'MongooseError' && err.message.includes('buffering timed out')) {
            console.error("\n❌ Mongoose Seeder Error: Operation timed out waiting for Primary.");
            console.error("This usually means the Replica Set is still electing a Primary.");
        } else {
            console.error("\n❌ Mongoose Seeder Error:", err.message);
        }
        
        console.error("HINT: Ensure the 'replicaSet=rs0' option is in your URI, and that you have run 'rs.initiate()' in the mongo shell.");
    } finally {
        await client.close();
        console.log("Connection closed.");
    }
}

// Execute the function
runSeeder();
