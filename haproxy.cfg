global
    log stdout format raw local0
    maxconn 65536
    tune.ssl.default-dh-param 2048
    tune.maxaccept 1024

defaults
    log     global
    mode    http
    option  tcplog
    timeout connect 5000ms
    timeout client  120000ms  # Increased for WebSocket
    timeout server  120000ms  # Increased for WebSocket

frontend ws_frontend
    bind *:9000
    mode http
    default_backend ws_backend

backend ws_backend
    # Use leastconn to better distribute long-lived connections compared to roundrobin
    balance leastconn
    mode http

    # 1. CRITICAL: Inject a cookie named 'SERVERID' into the client response.
    # 'insert' adds the cookie; 'indirect' means it's only for sticky servers; 'nocache' prevents caching proxies from interfering.
    cookie SERVERID insert indirect nocache

    server chat-api-1 chat-api-1:4041 check inter 1000 rise 2 fall 3 maxconn 2048 cookie server1
    server chat-api-2 chat-api-2:4142 check inter 1000 rise 2 fall 3 maxconn 2048 cookie server2
    server chat-api-3 chat-api-3:4143 check inter 1000 rise 2 fall 3 maxconn 2048 cookie server3
    server chat-api-4 chat-api-4:4144 check inter 1000 rise 2 fall 3 maxconn 2048 cookie server4
    server chat-api-5 chat-api-5:4145 check inter 1000 rise 2 fall 3 maxconn 2048 cookie server5
    server chat-api-6 chat-api-6:4146 check inter 1000 rise 2 fall 3 maxconn 2048 cookie server6
    server chat-api-7 chat-api-7:4147 check inter 1000 rise 2 fall 3 maxconn 2048 cookie server7
    server chat-api-8 chat-api-8:4148 check inter 1000 rise 2 fall 3 maxconn 2048 cookie server8

# Stats interface (Optional)
listen stats
    bind *:8400
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats auth admin:admin
